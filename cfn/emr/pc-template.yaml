AWSTemplateFormatVersion: '2010-09-09'
##++++++++++++++++++++++++++++##
##      /--- EMR CFN ---/     ##
##   Type: Persistent Cluster ##
##   Version: 1.0             ##
##++++++++++++++++++++++++++++##
Description: Cloudformation template for creating an EMR Persistent cluster
##+++++++++++++++++++++##
##------ Metadata -----##
##+++++++++++++++++++++##
Metadata: 
  AWS::CloudFormation::Interface: 
    ParameterGroups:
      - Label:
          default: "App Configuration"
        Parameters:
          - AppId
          - EnvType
          - DataClassification
      - Label:
          default: "EDO App Settings"
        Parameters:
          - EDOSDLCEnv
          - EDOLoBNm
          - appname
          - EDOApplWEId
      - Label: 
          default: "EMR Cluster Configurations"
        Parameters: 
          - ReleaseLabel
          - MasterInstanceType
          - CoreInstanceType
          - TaskInstanceType

      - Label:
          default: "EMR Auto-Scaling Settings"
        Parameters: 
          - MaximumCapacityUnits
          - MinCoreInstanceCount
          - MaxCoreInstanceCount
          - SpotPrice

      - Label: 
          default: "EMR EC2 Settings"
        Parameters: 
          - ebscoresize
          - ebscorecount
          - ebstasksize
          - ebstaskcount
          - SubnetId
          - TeamDL
Conditions:
  WithSpotPrice:
    Fn::Not:
    - Fn::Equals:
      - Ref: SpotPrice
      - '0'
  IsProd: !Equals [PROD, !Ref EnvType]
  UseVersionCondition: !Equals [!Ref ReleaseLabel, emr5290]
##+++++++++++++++++++++##
##---- Parameters -----##
##+++++++++++++++++++++##
Parameters:
  AppId:
    Type: Number
    Description: PlanIT application ID without APP- (ex. 4646)
    Default: 4304
  
  DataClassification:
    Type: String
    Description: Instance data classification
    Default: NonConfidential
    AllowedValues:
      - NonConfidential
      - CompanyConfidential
      - HighlyRestricted
    
  EnvType:
    Type: String
    AllowedValues:
       - NONPROD
       - PROD
    Default: NONPROD
    
  MasterInstanceType:
    Description: Enter Instance type for the nodes
    Type: String
    Default: m5.xlarge
    AllowedValues:
        - m4.large
        - m5.xlarge
        - r5.2xlarge
        - r5.4xlarge
        - r5.8xlarge
        - m6g.xlarge
        - m6g.2xlarge
        - m6g.4xlarge
        - m6g.8xlarge
        - r6g.xlarge
        - r6g.2xlarge 
        - r6g.4xlarge
        - r6g.8xlarge
  CoreInstanceType:
    Description: Enter Instance type for the nodes
    Type: String
    Default: m5.xlarge
    AllowedValues:
        - m4.large
        - m5.xlarge
        - r5.xlarge
        - r5.4xlarge
        - r5.8xlarge
        - m6g.xlarge
        - m6g.2xlarge
        - m6g.4xlarge
        - m6g.8xlarge
        - r6g.xlarge
        - r6g.2xlarge 
        - r6g.4xlarge
        - r6g.8xlarge
        
  TaskInstanceType:
    Description: Enter Instance type for the nodes
    Type: String
    Default: m5.xlarge
    AllowedValues:
        - m4.large
        - m5.xlarge
        - r5.xlarge
        - r5.4xlarge
        - r5.8xlarge
        - m6g.xlarge
        - m6g.2xlarge
        - m6g.4xlarge
        - m6g.8xlarge
        - r6g.xlarge
        - r6g.2xlarge 
        - r6g.4xlarge
        - r6g.8xlarge
        
  MaximumCapacityUnits:
    Description: Maximum number of nodes for the EMR cluster. (1-99 nodes).
    Type: Number
    Default: 10
    
  MinCoreInstanceCount:
    Description: Minimum Core instance count. Should be greater than 1.
    Type: String
    Default: 3

  MaxCoreInstanceCount:
    Description: Maximum Core instance count for the cluster
    Type: String
    Default: 5
    
  ebscoresize:
    Description: EBS Storage size for Core Nodes
    Type: String
    Default: 300
  
  ebscorecount:
    Description: EBS volume count for Core Nodes
    Type: String
    Default: 1

  ebstasksize:
    Description: EBS Storage size for Task Nodes
    Type: String
    Default: 100
  
  ebstaskcount:
    Description: EBS volume count for Rask Nodes
    Type: String
    Default: 1

  ReleaseLabel:
    Type: String
    Default: emr630
    AllowedValues:
      - emr620
      - emr630
      - emr640
      - emr650
    
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    ConstraintDescription: must be the name of an existing Subnet

  SpotPrice:
    Default: '0'
    Description: Spot price (or use 0 for "on-demand" instance)
    Type: Number
    
  EDOLoBNm:
    Type: String
    Description: Line Of Business Name
    Default: daes
    AllowedValues:
      - daes
      - cl
      - pl
      - gb
      - ent
      - clm
      - dgtl
      - hf
      - hr
      - ops
      - hmco
      - 3pd
      - clact
      - clmds
      - plact
      - plbi
      - clds
      - plds
      - gbds
      - gs  

  EDOSDLCEnv:
    Type: String
    Description: SDLC Environment Name
    Default: dev
    AllowedValues:
      - dev
      - qat
      - pte
      - ppd
      - prd

  EDOApplWEId:
    Type: String
    Description: Application Work Effort (WE) / PPM Id
    Default: NA
    
  appname:
    Description: "It would be used as suffix for emr cluster name. example: app1-dev-001"
    Type: String
    Default: "<Name>-<SDLC>-<nnn>"
    
  TeamDL:
    Description: EmailId for notification
    Default: 'HadoopAdmin@thehartford.com'
    Type: String

##+++++++++++++++++++++##
##------ Mapping ------##
##+++++++++++++++++++++##

Mappings:
  HiveMetaStore:
    Config:
      RdsUserName: "{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:username}}"
      RdsPassword: "{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:password}}"
      RdsJdbsUrl: "jdbc:{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:engine}}://{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:host}}:{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:port}}/{{resolve:secretsmanager:rds-db-credentials/edonpbd-rds-emr6-mysql-001/admin:SecretString:dbname}}?createDatabaseIfNotExist=true&amp;useSSL=true&amp;serverSslCert=/etc/hig/security/rds-combined-ca-bundle.pem"

  Cluster:
    Version:
      emr620: emr-6.2.0
      emr630: emr-6.3.0
      emr640: emr-6.4.0
      emr650: emr-6.5.0

  NONPROD:
    EnvParams:
      EmrCustomAmi: "{{resolve:ssm:/HIG/EDO/BASE/EMR/NP/ami}}"
      LogUri: "{{resolve:ssm:/HIG/EDO/BASE/EMR/NP/loguri}}"
      clusterservicerole: "{{resolve:ssm:/HIG/EDO/BASE/EMR/NP/clusterservicerole}}"
      HbaseRootDir: "s3://{{resolve:ssm:/HIG/EDO/BASE/EMR/hbases3}}/hbase/np"
    BootstrapScript:
      emr620: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/nonprod/bootstrap/emr620_boot_script.sh"
      emr630: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/nonprod/bootstrap/emr630_boot_script.sh"
      emr640: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/nonprod/bootstrap/emr640_boot_script.sh"
      emr650: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/nonprod/bootstrap/emr650_boot_script.sh"

  PROD:
    EnvParams:
      EmrCustomAmi: "{{resolve:ssm:/HIG/EDO/BASE/EMR/PD/ami}}"
      LogUri: "{{resolve:ssm:/HIG/EDO/BASE/EMR/PD/loguri}}"
      clusterservicerole: "{{resolve:ssm:/HIG/EDO/BASE/EMR/PD/clusterservicerole}}"
      HbaseRootDir: "s3://{{resolve:ssm:/HIG/EDO/BASE/EMR/hbases3}}/hbase/pd"
    BootstrapScript:
      emr620: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/prod/bootstrap/emr620_boot_script.sh"
      emr630: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/prod/bootstrap/emr630_boot_script.sh"
      emr640: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/prod/bootstrap/emr640_boot_script.sh"
      emr650: "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/prod/bootstrap/emr650_boot_script.sh"

  FetchDateTime:
    DateTime:
      DateTimeString:
        'Fn::Transform':
          Name: DateVersion


##+++++++++++++++++++++##
##----- Resources -----##
##+++++++++++++++++++++##
    
Resources:
  PersistentSecurityConfiguration:
    Type: AWS::EMR::SecurityConfiguration
    Properties:
      SecurityConfiguration:
        EncryptionConfiguration:
          AtRestEncryptionConfiguration:
            S3EncryptionConfiguration:
              Fn::Transform:
                Name: GetS3EncConf
              EncryptionMode: SSE-KMS
              AwsKmsKey: "{{resolve:ssm:/HIG/EDO/BASE/EMR/S3kmskey:1}}"
              Overrides: "$$REPLACEMENT$$"
            LocalDiskEncryptionConfiguration:
              EnableEbsEncryption: true
              EncryptionKeyProviderType: AwsKms
              AwsKmsKey: "{{resolve:ssm:/HIG/EDO/BASE/EMR/EBSkmskey:1}}"
          EnableInTransitEncryption: true
          InTransitEncryptionConfiguration:
            TLSCertificateConfiguration:
              CertificateProviderType: PEM
              S3Object: !If
                - IsProd
                - "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/prod/certificate/emrpdbd_cert.zip"
                - "s3://{{resolve:ssm:/HIG/EDO/BASE/S3/ArtifactBucketName:1}}/scripts/emr/persistent/nonprod/certificate/emrnpbd_cert.zip"
          EnableAtRestEncryption: true
  Clusteriamrole:
    DependsOn:
    - PersistentSecurityConfiguration  
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
#Standard HIG Ec2				  
        - PolicyName: higbase
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 
                  - "s3:GetObject"
                  - "s3:Listbucket"
                  - "s3:HeadBucket"
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::amazoncloudwatch-agent-${AWS::Region}/*" # CloudWatch Agent
                  - !Sub "arn:${AWS::Partition}:s3:::aws-ssm-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::aws-windows-downloads-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::amazon-ssm-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::amazon-ssm-packages-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::${AWS::Region}-birdwatcher-prod/*"
                  - !Sub "arn:${AWS::Partition}:s3:::aws-ssm-document-attachments-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::patch-baseline-snapshot-${AWS::Region}/*"
                  - !Sub "arn:${AWS::Partition}:s3:::amazonlinux.${AWS::Region}.amazonaws.com/*" # Amazon Linux 2 updates
                  - !Sub "arn:${AWS::Partition}:s3:::${AWS::Region}.elasticmapreduce"
                  - !Sub "arn:${AWS::Partition}:s3:::${AWS::Region}.elasticmapreduce/*"
                  - !Sub "arn:${AWS::Partition}:s3:::packages.*.amazonaws.com"
                  - !Sub "arn:${AWS::Partition}:s3:::packages.*.amazonaws.com/*"
                  - !Sub "arn:${AWS::Partition}:s3:::repo.*.amazonaws.com"
                  - !Sub "arn:${AWS::Partition}:s3:::repo.*.amazonaws.com/*"
                  - !Sub "arn:${AWS::Partition}:s3:::aws-edoce-hig-artifacts"
                  - !Sub "arn:${AWS::Partition}:s3:::aws-edoce-hig-artifacts/*"                  
              - Effect: Allow
                Action:
                  - "ec2:Describe*"
                  - "ec2:CreateTags"
                Resource: "*"
#Cluster policy
        - PolicyName: emrpolicy1
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - "s3:ListAllMyBuckets"
                  - "s3:GetBucketLocation"
                  - "s3:HeadBucket"
                  - "kms:Decrypt"
                  - "kms:Encrypt"
                  - "kms:ListAliases"
                  - "kms:GenerateDataKey"
                  - "kms:DescribeKey"
                  - "glue:CreateDatabase"
                  - "glue:UpdateDatabase"
                  - "glue:DeleteDatabase"
                  - "glue:GetDatabase"
                  - "glue:GetDatabases"
                  - "glue:CreateTable"
                  - "glue:UpdateTable"
                  - "glue:DeleteTable"
                  - "glue:GetTable"
                  - "glue:GetTables"
                  - "glue:GetTableVersions"
                  - "glue:CreatePartition"
                  - "glue:BatchCreatePartition"
                  - "glue:UpdatePartition"
                  - "glue:DeletePartition"
                  - "glue:BatchDeletePartition"
                  - "glue:GetPartition"
                  - "glue:GetPartitions"
                  - "glue:BatchGetPartition"
                  - "glue:CreateUserDefinedFunction"
                  - "glue:UpdateUserDefinedFunction"
                  - "glue:DeleteUserDefinedFunction"
                  - "glue:GetUserDefinedFunction"
                  - "glue:GetUserDefinedFunctions"
                  - "ec2:*Volume*"
                  - "ec2:Describe*"
                  - "ec2:CreateTags"
                  - "elasticmapreduce:Describe*"
                  - "elasticmapreduce:ListBootstrapActions"
                  - "elasticmapreduce:ListClusters"
                  - "elasticmapreduce:ListInstanceGroups"
                  - "elasticmapreduce:ListInstances"
                  - "elasticmapreduce:ListSteps"
                Resource: "*"
              - Effect: Allow
                Action:
                  - "s3:ListBucket"
                  - "s3:GetObject"
                  - "s3:PutObject"
                  - "s3:AbortMultipartUpload"
                  - "s3:PutObjectRetention"
                  - "s3:DeleteObjectVersion"
                  - "s3:DeleteObject"
                  - "s3:GetBucketVersioning"
                  - "s3:GetObjectTagging"
                  - "s3:GetObjectVersion"
                  - "s3:ListBucketMultipartUploads"
                  - "s3:ListBucketVersions"
                  - "s3:ListMultipartUploadParts"
                  - "s3:PutBucketVersioning"
                  - "s3:PutObjectTagging"                  
                Resource:
                  - !Sub "arn:${AWS::Partition}:s3:::edo-np-bd-emr-admin-001"
                  - !Sub "arn:${AWS::Partition}:s3:::edo-np-bd-emr-admin-001/*"
                  - !Sub "arn:${AWS::Partition}:s3:::edo-np-bd-emr-admin-001"
                  - !Sub "arn:${AWS::Partition}:s3:::edo-np-bd-emr-admin-001/*"                  
      ManagedPolicyArns:
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMManagedInstanceCore"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/CloudWatchAgentServerPolicy"
        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonSSMDirectoryServiceAccess"
  EMRCluster:
    DependsOn:
    - PersistentSecurityConfiguration
    Type: AWS::EMR::Cluster
    Properties:
      SecurityConfiguration:
        Ref: PersistentSecurityConfiguration
      #KerberosAttributes:
      #  CrossRealmTrustPrincipalPassword: "test"
      #  KdcAdminPassword: "test"
      #  Realm: "EC2.INTERNAL"
      Applications:
      # Add additional supported EMR applications here  
        - Name: Hadoop
        - Name: Hive
        - Name: HCatalog
        - Name: Spark
        - Name: Tez
        - Name: Pig
      # - Name: HBase
        - Name: Phoenix
        - Name: Sqoop 
        - Name: Presto
        - Name: ZooKeeper
      EbsRootVolumeSize: 100
      Instances:
        Ec2KeyName: "{{resolve:ssm:/HIG/EDO/BASE/EMR/keypair:1}}"
        Ec2SubnetId: !Ref SubnetId
        MasterInstanceGroup:
          InstanceCount: 1
          InstanceType: !Ref MasterInstanceType
          Market: ON_DEMAND
          Name: !Sub "EMR-Master-APP-${AppId}"
        CoreInstanceGroup:
          InstanceCount: !Ref MinCoreInstanceCount
          InstanceType: !Ref CoreInstanceType
          Market: ON_DEMAND
          Name: !Sub "EMR-Core-APP-${AppId}"
          EbsConfiguration:
            EbsBlockDeviceConfigs:
            - VolumeSpecification:
                SizeInGB: !Ref ebscoresize
                VolumeType: gp2
              VolumesPerInstance: !Ref ebscorecount
            EbsOptimized: 'true'
          BidPrice:
            Fn::If:
             - WithSpotPrice
             - Ref: SpotPrice
             - Ref: AWS::NoValue
             
        TerminationProtected: 'false'
        KeepJobFlowAliveWhenNoSteps: 'True'
      Name:  !Sub "{{resolve:ssm:/HIG/EDO/BASE/GOV/AccountName:1}}-emr-${appname}"
      JobFlowRole: "{{resolve:ssm:/HIG/EDO/BASE/EMR/jobflowrole:1}}"
      ServiceRole: !FindInMap  
                 - !Ref EnvType
                 - EnvParams
                 - clusterservicerole
      AutoScalingRole: EMR_AutoScaling_DefaultRole
      ReleaseLabel: !FindInMap
        - Cluster
        - Version
        - !Ref ReleaseLabel
      ManagedScalingPolicy:
        !If
        - UseVersionCondition
        - Ref: AWS::NoValue
        - 
          ComputeLimits:
              MaximumCapacityUnits: !Ref MaximumCapacityUnits
              MaximumCoreCapacityUnits: !Ref MaxCoreInstanceCount
              MaximumOnDemandCapacityUnits: !Ref MaxCoreInstanceCount
              MinimumCapacityUnits: !Ref MinCoreInstanceCount
              UnitType: 'Instances'
      VisibleToAllUsers: true
      LogUri: !FindInMap  
          - !Ref EnvType
          - EnvParams
          - LogUri
      CustomAmiId: !FindInMap  
                 - !Ref EnvType
                 - EnvParams
                 - EmrCustomAmi
      Configurations:
      - Classification: hbase-site
        ConfigurationProperties:
          hbase.rootdir: !Join
                 - '-'
                 - - !Join
                     - '/'
                     - - !FindInMap
                         - !Ref EnvType
                         - EnvParams
                         - HbaseRootDir
                       - !Ref appname
                   - !FindInMap
                     - FetchDateTime
                     - DateTime
                     - DateTimeString
      - Classification: hbase
        ConfigurationProperties:
          hbase.emr.storageMode: s3
      - Classification: core-site
        ConfigurationProperties:
          fs.s3.canned.acl: BucketOwnerFullControl                  
         
      - Classification: hdfs-site
        ConfigurationProperties:
          dfs.permissions.enabled: true
          dfs.permissions: true

      - Classification: mapred-site
        ConfigurationProperties:
          mapreduce.job.queuename: short

      - Classification: tez-site
        ConfigurationProperties:
          tez.queue.name: short

      - Classification: yarn-site
        ConfigurationProperties:
          yarn.log-aggregation.retain-seconds: 172800
          yarn.log-aggregation-enable: true
      #   yarn.nodemanager.vmem-check-enabled: false
          yarn.scheduler.minimum-allocation-mb: 32
          yarn.resourcemanager.monitor.capacity.preemption.intra-queue-preemption.enabled: true
          yarn.resourcemanager.nodemanager-graceful-decommission-timeout-secs: 3600
 
      - Classification: capacity-scheduler
        ConfigurationProperties:
          yarn.scheduler.capacity.maximum-am-resource-percent: 0.2
          yarn.scheduler.capacity.root.analytics.capacity: 40
          yarn.scheduler.capacity.root.analytics.long.capacity: 50
          yarn.scheduler.capacity.root.analytics.long.maximum-capacity: 50
          yarn.scheduler.capacity.root.analytics.long.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.analytics.long.user-limit-factor: 4
          yarn.scheduler.capacity.root.analytics.maximum-capacity: 80
          yarn.scheduler.capacity.root.analytics.minimum-user-limit-percent: 5
          yarn.scheduler.capacity.root.analytics.queues: long,short
          yarn.scheduler.capacity.root.analytics.short.capacity: 50
          yarn.scheduler.capacity.root.analytics.short.maximum-capacity: 70
          yarn.scheduler.capacity.root.analytics.short.minimum-user-limit-percent: 5
          yarn.scheduler.capacity.root.analytics.short.user-limit-factor: 4
          yarn.scheduler.capacity.root.analytics.user-limit-factor: 5
          yarn.scheduler.capacity.root.capacity: 100
          yarn.scheduler.capacity.root.default.acl_submit_applications: yarn
          yarn.scheduler.capacity.root.default.capacity: 20
          yarn.scheduler.capacity.root.default.maximum-capacity: 30
          yarn.scheduler.capacity.root.default.minimum-user-limit-percent: 5
          yarn.scheduler.capacity.root.default.user-limit-factor: 5
          yarn.scheduler.capacity.root.minimum-user-limit-percent: 5
          yarn.scheduler.capacity.root.operations.capacity: 40
          yarn.scheduler.capacity.root.operations.maximum-capacity: 60
          yarn.scheduler.capacity.root.operations.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.operations.priority: 5
          yarn.scheduler.capacity.root.operations.user-limit-factor: 3
          yarn.scheduler.capacity.root.queues: analytics,default,operations
          yarn.scheduler.capacity.root.default.accessible-node-labels.CORE.capacity: 20
          yarn.scheduler.capacity.root.default.accessible-node-labels.CORE.maximum-capacity: 30
          yarn.scheduler.capacity.root.default.accessible-node-labels.CORE.minimum-user-limit-percent: 5
          yarn.scheduler.capacity.root.default.accessible-node-labels.CORE.user-limit-factor: 4
          yarn.scheduler.capacity.root.operations.accessible-node-labels.CORE.capacity: 40
          yarn.scheduler.capacity.root.operations.accessible-node-labels.CORE.maximum-capacity: 70
          yarn.scheduler.capacity.root.operations.accessible-node-labels.CORE.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.operations.accessible-node-labels.CORE.user-limit-factor: 5
          yarn.scheduler.capacity.root.analytics.accessible-node-labels.CORE.maximum-capacity: 60
          yarn.scheduler.capacity.root.analytics.accessible-node-labels.CORE.queues: long,short
          yarn.scheduler.capacity.root.analytics.accessible-node-labels.CORE.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.analytics.accessible-node-labels.CORE.user-limit-factor: 5
          yarn.scheduler.capacity.root.analytics.accessible-node-labels.CORE.capacity: 40
          yarn.scheduler.capacity.root.analytics.short.accessible-node-labels.CORE.capacity: 50
          yarn.scheduler.capacity.root.analytics.short.accessible-node-labels.CORE.maximum-capacity: 70
          yarn.scheduler.capacity.root.analytics.short.accessible-node-labels.CORE.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.analytics.short.accessible-node-labels.CORE.user-limit-factor: 5
          yarn.scheduler.capacity.root.analytics.long.accessible-node-labels.CORE.minimum-user-limit-percent: 10
          yarn.scheduler.capacity.root.analytics.long.accessible-node-labels.CORE.user-limit-factor: 5
          yarn.scheduler.capacity.root.analytics.long.accessible-node-labels.CORE.capacity: 50
          yarn.scheduler.capacity.root.analytics.long.accessible-node-labels.CORE.maximum-capacity: 50
          yarn.scheduler.capacity.root.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E
          yarn.scheduler.capacity.root.analytics.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E
          yarn.scheduler.capacity.root.analytics.long.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E
          yarn.scheduler.capacity.root.analytics.short.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E
          yarn.scheduler.capacity.root.default.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E
          yarn.scheduler.capacity.root.operations.acl_administer_queue: yarn,dr.who,ms67179e,co26429e,co26717e,pb98111e,admin,cpg8153e,tk94145e,cog10826e,co28018e,co27658e DAT-DI-HADOOP-ADMINISTRATOR-ADMIN-E

      - Classification: hive-site
        ConfigurationProperties:
          hive.server2.logging.operation.enabled: true
          hive.server2.parallel.ops.in.session: true                                    
          javax.jdo.option.ConnectionUserName: !FindInMap
            - HiveMetaStore
            - Config
            - RdsUserName
          javax.jdo.option.ConnectionDriverName: org.mariadb.jdbc.Driver
          javax.jdo.option.ConnectionPassword: !FindInMap
            - HiveMetaStore
            - Config
            - RdsPassword
          javax.jdo.option.ConnectionURL: !FindInMap
            - HiveMetaStore
            - Config
            - RdsJdbsUrl
      - Classification: hadoop-env
        Configurations:
        - Classification: export
          ConfigurationProperties:
              HADOOP_HEAPSIZE: 8192
    
      - Classification: hadoop-log4j
        ConfigurationProperties:
          hadoop.log.maxfilesize: 1024MB
          hadoop.root.logger: ERROR,console
          hdfs.audit.log.maxfilesize: 1024MB
          hadoop.security.log.maxfilesize: 1024MB
          mapred.audit.log.maxfilesize: 1024MB
          hadoop.mapreduce.jobsummary.log.maxfilesize: 1024MB
                                                  
      - Classification: hive-beeline-log4j2
        ConfigurationProperties:
          status: ERROR
          logger.HiveConnection.level: ERROR

      - Classification: hive-log4j2
        ConfigurationProperties:
          rootLogger.level: ERROR

      - Classification: spark-defaults
        ConfigurationProperties:
          spark.debug.maxToStringFields: 100
          spark.port.maxRetries: 100
          spark.history.fs.cleaner.enabled: true
          spark.history.fs.cleaner.interval: 1d
          spark.history.fs.cleaner.maxAge: 2d

      BootstrapActions:
        - Name: EMRbootstrapsetup
          ScriptBootstrapAction:
            Path: !FindInMap  
              - !Ref EnvType
              - BootstrapScript
              - !Ref ReleaseLabel
      Tags:
        -
          Key: "hig-billing"
          Value: !Sub "APP-${AppId}"
        -
          Key: "hig-planit-appid"
          Value: !Sub "APP-${AppId}-EMR"
        -
          Key: "hig-environment-type"
          Value: !Ref EnvType
        -
          Key: "hig-created-by"
          Value: "Hadoop Admin"
        -
          Key: "hig-data-classification"
          Value: !Ref DataClassification
        -
          Key: "hig-owner"
          Value: "HadoopAdmin@thehartford.com"
        - Key: EDO-LoB-Nm
          Value: !Ref EDOLoBNm
        - Key: EDO-Appl-Nm
          Value: !Ref appname
        - Key: EDO-SDLC-Env
          Value: !Ref EDOSDLCEnv
        - Key: EDO-Appl-WE-Id
          Value: !Ref EDOApplWEId		  
        - Key: Hostname
          Value: edonpbdemr212
          
  # EMRSteps:
    # Type: AWS::EMR::Step
    # DependsOn:
    # - EMRCluster
    # Properties: 
      # ActionOnFailure: CONTINUE
      # HadoopJarStep: 
        # Args:
            # - !FindInMap
                # - !Ref EnvType
                # - BootstrapScript
                # - !Ref ReleaseLabel
        # Jar: s3://us-east-1.elasticmapreduce/libs/script-runner/script-runner.jar
      # JobFlowId: !Ref EMRCluster
      # Name: ADJoin
  
  ruleTopic:
    DependsOn:
    - EMRCluster
    Type: AWS::SNS::Topic
    Properties:
      Subscription: 
        - Endpoint: !Ref TeamDL
          Protocol: email
          
  eventRule:
   DependsOn:
   - ruleTopic  
   Type: AWS::Events::Rule
   Properties:
     Description: 'Alerts get triggered when new emr transient cluster get created or a cluster terminated'
     EventPattern:
       source:
         - 'aws.emr'
       detail-type:
         - 'EMR Cluster State Change'
         - 'EMR Auto Scaling Policy State Change'
         - 'EMR Step Status Change'
         - 'EMR Instance Group State Change'
         - 'EMR Instance Fleet State Change'
         - 'EMR Instance Group Status Notification'
       detail:
         clusterId: 
           - !Ref EMRCluster
     State: "ENABLED"
     Targets:
      - 
       Arn: !Ref ruleTopic
       Id: eventRule

  eventTopicPolicy:
    DependsOn:
    - eventRule  
    Type: 'AWS::SNS::TopicPolicy'
    Properties:
        PolicyDocument:
            Statement:
                - Effect: Allow
                  Principal:
                    Service: events.amazonaws.com
                  Action: 'sns:Publish'
                  Resource: '*'
        Topics:
            - !Ref ruleTopic
            
  EMRDashboard:
   DependsOn:
   - EMRCluster
   Type: AWS::CloudWatch::Dashboard
   Properties:
     DashboardName: !Ref EMRCluster
     DashboardBody: !Sub |
       {
       "widgets": [
           {
            "height": 3,
            "width": 3,
            "y": 9,
            "x": 18,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/S3", "NumberOfObjects", "StorageType", "AllStorageTypes", "BucketName", "aws-edoce-s3-lake-001", { "period": 86400, "label": "3001 NumberOfObjects", "stat": "Maximum" } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "S3 # of Objects",
                "period": 604800
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 9,
            "x": 3,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MemoryReservedMB", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "memory reserved",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 0,
            "x": 0,
            "type": "text",
            "properties": {
                "markdown": "\n# EMR Dashboard \n## job-flow-id = ${EMRCluster} \n"
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRLostNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "mr-lost",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 6,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "HDFSUtilization", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "hdfs - utilization",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 0,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "ContainerReserved", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "container reserved",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 18,
            "x": 18,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "PendingDeletionBlocks", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "pending delete",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRDecommissionedNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "mr decomm",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 0,
            "x": 8,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsRunning", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "apps-running",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 9,
            "x": 6,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MemoryAllocatedMB", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "memory-allocated",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 9,
            "x": 0,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MemoryTotalMB", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "memory-total",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 0,
            "x": 14,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsFailed", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "apps-failed",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 0,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRTotalNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "MR total",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 6,
            "x": 0,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsSubmitted", "JobFlowId", "${EMRCluster}" ],
                    [ ".", "MRTotalNodes", ".", ".", { "visible": false } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "apps-submitted",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 15,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "TotalLoad", "JobFlowId", "${EMRCluster}" ],
                    [ ".", "MRActiveNodes", ".", ".", { "visible": false } ],
                    [ ".", "CapacityRemainingGB", ".", ".", { "visible": false } ],
                    [ ".", "AppsKilled", ".", ".", { "visible": false } ],
                    [ ".", "MRUnhealthyNodes", ".", ".", { "visible": false } ],
                    [ ".", "ContainerPendingRatio", ".", ".", { "visible": false } ],
                    [ ".", "MissingBlocks", ".", ".", { "visible": false } ],
                    [ ".", "YARNMemoryAvailablePercentage", ".", ".", { "visible": false } ],
                    [ ".", "MemoryAvailableMB", ".", ".", { "visible": false } ],
                    [ ".", "MRRebootedNodes", ".", ".", { "visible": false } ],
                    [ ".", "AppsPending", ".", ".", { "visible": false } ],
                    [ ".", "S3BytesRead", ".", ".", { "visible": false } ],
                    [ ".", "HDFSBytesWritten", ".", ".", { "visible": false } ],
                    [ ".", "dfs.FSNamesystem.PendingReplicationBlocks", ".", ".", { "visible": false } ],
                    [ ".", "ContainerAllocated", ".", ".", { "visible": false } ],
                    [ ".", "CoreNodesPending", ".", ".", { "visible": false } ],
                    [ ".", "ContainerReserved", ".", ".", { "visible": false } ],
                    [ ".", "TaskNodesRunning", ".", ".", { "visible": false } ],
                    [ ".", "S3BytesWritten", ".", ".", { "visible": false } ],
                    [ ".", "UnderReplicatedBlocks", ".", ".", { "visible": false } ],
                    [ ".", "CorruptBlocks", ".", ".", { "visible": false } ],
                    [ ".", "HDFSUtilization", ".", ".", { "visible": false } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "Total Load",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 18,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "CoreNodesRunning", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "CoreNodesRunning",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 6,
            "x": 6,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsCompleted", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "Apps Completed",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 3,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "ContainerPending", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "container-pending",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MissingBlocks", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "missing blocks",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 6,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRUnhealthyNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "MR Unhealthy Nodes",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 0,
            "x": 17,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsKilled", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "Apps Killed",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 3,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRActiveNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "MR Active Nodes",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 21,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "CoreNodesPending", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "Core Nodes Pending",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 6,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "ContainerAllocated", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "container allocated",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 18,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "dfs.FSNamesystem.PendingReplicationBlocks", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "dfs.FSNamesystem.PendingReplicationBlocks",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 6,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "HDFSBytesWritten", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "HDFS Bytes Written",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 9,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "S3BytesRead", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "S3 Bytes Read",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 0,
            "x": 11,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "AppsPending", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "Apps Pending",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 3,
            "x": 12,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MRRebootedNodes", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "MR Reboot Nodes",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 15,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "YARNMemoryAvailablePercentage", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "Yarn Memory Available %",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "UnderReplicatedBlocks", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "under replicated blocks",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 12,
            "x": 12,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "CorruptBlocks", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "singleValue",
                "stacked": false,
                "region": "us-east-1",
                "title": "Corrupt Blocks",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0,
                        "max": 100
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 6,
            "x": 21,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "HDFSBytesRead", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "hdfs-read",
                "period": 300,
                "yAxis": {
                    "left": {
                        "min": 0
                    }
                }
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 18,
            "x": 9,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "CoreNodesRunning", "JobFlowId", "${EMRCluster}" ],
                    [ ".", "TaskNodesPending", ".", ".", { "visible": false } ],
                    [ ".", "YARNMemoryAvailablePercentage", ".", ".", { "visible": false } ],
                    [ ".", "ContainerAllocated", ".", ".", { "visible": false } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "Capacity Remaining GB",
                "period": 300
            }
        },
        {
            "height": 6,
            "width": 9,
            "y": 15,
            "x": 0,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "MemoryAllocatedMB", "JobFlowId", "${EMRCluster}", { "color": "#ff7f0e" } ],
                    [ ".", "MemoryReservedMB", ".", ".", { "visible": false } ],
                    [ ".", "MemoryAvailableMB", ".", "." ],
                    [ ".", "MemoryTotalMB", ".", ".", { "visible": false } ]
                ],
                "view": "timeSeries",
                "stacked": true,
                "region": "us-east-1",
                "title": "MemoryAllocatedMB, MemoryAvailableMB",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 3,
            "y": 9,
            "x": 15,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/ElasticMapReduce", "S3BytesWritten", "JobFlowId", "${EMRCluster}" ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "S3 Bytes Written",
                "period": 300
            }
        },
        {
            "height": 3,
            "width": 6,
            "y": 12,
            "x": 18,
            "type": "metric",
            "properties": {
                "metrics": [
                    [ "AWS/S3", "BucketSizeBytes", "StorageType", "StandardStorage", "BucketName", "aws-edoce-s3-lake-001", { "label": "3001 BucketSizeBytes" } ]
                ],
                "view": "timeSeries",
                "stacked": false,
                "region": "us-east-1",
                "title": "S3 Bucket Size",
                "period": 21600,
                "yAxis": {
                    "left": {
                        "min": 0
                    }
                },
                "stat": "Sum"
            }
          }
         ]
       }
       
          
    
##+++++++++++++++++++++##
##------ Outputs ------##
##+++++++++++++++++++++##

Outputs:

  YARNResourceManager:
    Description: Web URL for access to your EMR Clusters
    Value: !Join ["", ['http://',!GetAtt EMRCluster.MasterPublicDNS,':8088']]

  SparkHistoryServer:
    Description: Web URL for access to your EMR Clusters
    Value: !Join ["", ['http://',!GetAtt EMRCluster.MasterPublicDNS,':18080']]
